<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>cross_plat_2.html</title>
    <style>
      body,
      html {
        background-color: #272822;
        padding: 0;
        margin: 0;
        position: relative;
        line-height:24px;
     }
      pre {
        margin: 0;
        padding: 0;
      }
      #linenums {
        width: 60px;
        position: absolute;
        background-color: #38284e;
        -webkit-user-select:none;/*webkit浏览器*/
        -ms-user-select:none;/*IE10*/
        user-select:none;
      }
      #linenums span {
        width: 60px;
        display: inline-block;
        position: relative;
        left: -6px;
      }
      #codes {
        position: absolute;
        min-width: calc(100% - 66px);
        width: max-content;
        margin-left: 64px;
      }
    </style>
  </head>

  <body>
    <div id="linenums">
      <div style="font-family:Consolas;font-size:24px;color:gainsboro;">      <span style="color:#4dc742; text-align:right">1</span>
      <span style="color:#4dc742; text-align:right">2</span>
      <span style="color:#4dc742; text-align:right">3</span>
      <span style="color:#4dc742; text-align:right">4</span>
      <span style="color:#4dc742; text-align:right">5</span>
      <span style="color:#4dc742; text-align:right">6</span>
      <span style="color:#4dc742; text-align:right">7</span>
      <span style="color:#4dc742; text-align:right">8</span>
      <span style="color:#4dc742; text-align:right">9</span>
      <span style="color:#4dc742; text-align:right">10</span>
      <span style="color:#4dc742; text-align:right">11</span>
      <span style="color:#4dc742; text-align:right">12</span>
      <span style="color:#4dc742; text-align:right">13</span>
      <span style="color:#4dc742; text-align:right">14</span>
      <span style="color:#4dc742; text-align:right">15</span>
      <span style="color:#4dc742; text-align:right">16</span>
      <span style="color:#4dc742; text-align:right">17</span>
      <span style="color:#4dc742; text-align:right">18</span>
      <span style="color:#4dc742; text-align:right">19</span>
      <span style="color:#4dc742; text-align:right">20</span>
      <span style="color:#4dc742; text-align:right">21</span>
      <span style="color:#4dc742; text-align:right">22</span>
      <span style="color:#4dc742; text-align:right">23</span>
      <span style="color:#4dc742; text-align:right">24</span>
      <span style="color:#4dc742; text-align:right">25</span>
      <span style="color:#4dc742; text-align:right">26</span>
      <span style="color:#4dc742; text-align:right">27</span>
      <span style="color:#4dc742; text-align:right">28</span>
      <span style="color:#4dc742; text-align:right">29</span>
      <span style="color:#4dc742; text-align:right">30</span>
      <span style="color:#4dc742; text-align:right">31</span>
      <span style="color:#4dc742; text-align:right">32</span>
      <span style="color:#4dc742; text-align:right">33</span>
      <span style="color:#4dc742; text-align:right">34</span>
      <span style="color:#4dc742; text-align:right">35</span>
      <span style="color:#4dc742; text-align:right">36</span>
      <span style="color:#4dc742; text-align:right">37</span>
      <span style="color:#4dc742; text-align:right">38</span>
      <span style="color:#4dc742; text-align:right">39</span>
      <span style="color:#4dc742; text-align:right">40</span>
      <span style="color:#4dc742; text-align:right">41</span>
      <span style="color:#4dc742; text-align:right">42</span>
      <span style="color:#4dc742; text-align:right">43</span>
      <span style="color:#4dc742; text-align:right">44</span>
      <span style="color:#4dc742; text-align:right">45</span>
      <span style="color:#4dc742; text-align:right">46</span>
      <span style="color:#4dc742; text-align:right">47</span>
      <span style="color:#4dc742; text-align:right">48</span>
      <span style="color:#4dc742; text-align:right">49</span>
      <span style="color:#4dc742; text-align:right">50</span>
      <span style="color:#4dc742; text-align:right">51</span>
      <span style="color:#4dc742; text-align:right">52</span>
      <span style="color:#4dc742; text-align:right">53</span>
      <span style="color:#4dc742; text-align:right">54</span>
      <span style="color:#4dc742; text-align:right">55</span>
      <span style="color:#4dc742; text-align:right">56</span>
      <span style="color:#4dc742; text-align:right">57</span>
      <span style="color:#4dc742; text-align:right">58</span>
      <span style="color:#4dc742; text-align:right">59</span>
      <span style="color:#4dc742; text-align:right">60</span>
      <span style="color:#4dc742; text-align:right">61</span>
      <span style="color:#4dc742; text-align:right">62</span>
      <span style="color:#4dc742; text-align:right">63</span>
      <span style="color:#4dc742; text-align:right">64</span>
      <span style="color:#4dc742; text-align:right">65</span>
      <span style="color:#4dc742; text-align:right">66</span>
      <span style="color:#4dc742; text-align:right">67</span>
      <span style="color:#4dc742; text-align:right">68</span>
      <span style="color:#4dc742; text-align:right">69</span>
      <span style="color:#4dc742; text-align:right">70</span>
      <span style="color:#4dc742; text-align:right">71</span>
      <span style="color:#4dc742; text-align:right">72</span>
      <span style="color:#4dc742; text-align:right">73</span>
      <span style="color:#4dc742; text-align:right">74</span>
      <span style="color:#4dc742; text-align:right">75</span>
      <span style="color:#4dc742; text-align:right">76</span>
      <span style="color:#4dc742; text-align:right">77</span>
      <span style="color:#4dc742; text-align:right">78</span>
      <span style="color:#4dc742; text-align:right">79</span>
      <span style="color:#4dc742; text-align:right">80</span>
      <span style="color:#4dc742; text-align:right">81</span>
      <span style="color:#4dc742; text-align:right">82</span>
      <span style="color:#4dc742; text-align:right">83</span>
      <span style="color:#4dc742; text-align:right">84</span>
      <span style="color:#4dc742; text-align:right">85</span>
      <span style="color:#4dc742; text-align:right">86</span>
      <span style="color:#4dc742; text-align:right">87</span>
      <span style="color:#4dc742; text-align:right">88</span>
      <span style="color:#4dc742; text-align:right">89</span>
      <span style="color:#4dc742; text-align:right">90</span>
      <span style="color:#4dc742; text-align:right">91</span>
      <span style="color:#4dc742; text-align:right">92</span>
      <span style="color:#4dc742; text-align:right">93</span>
      <span style="color:#4dc742; text-align:right">94</span>
      <span style="color:#4dc742; text-align:right">95</span>
      <span style="color:#4dc742; text-align:right">96</span>
      <span style="color:#4dc742; text-align:right">97</span>
      <span style="color:#4dc742; text-align:right">98</span>
      <span style="color:#4dc742; text-align:right">99</span>
      <span style="color:#4dc742; text-align:right">100</span>
      <span style="color:#4dc742; text-align:right">101</span>
      <span style="color:#4dc742; text-align:right">102</span>
      <span style="color:#4dc742; text-align:right">103</span>
      <span style="color:#4dc742; text-align:right">104</span>
      <span style="color:#4dc742; text-align:right">105</span>
      <span style="color:#4dc742; text-align:right">106</span>
      <span style="color:#4dc742; text-align:right">107</span>
      <span style="color:#4dc742; text-align:right">108</span>
      <span style="color:#4dc742; text-align:right">109</span>
      <span style="color:#4dc742; text-align:right">110</span>
      <span style="color:#4dc742; text-align:right">111</span>
      <span style="color:#4dc742; text-align:right">112</span>
      <span style="color:#4dc742; text-align:right">113</span>
      <span style="color:#4dc742; text-align:right">114</span>
      <span style="color:#4dc742; text-align:right">115</span>
      <span style="color:#4dc742; text-align:right">116</span>
      <span style="color:#4dc742; text-align:right">117</span>
      <span style="color:#4dc742; text-align:right">118</span>
      <span style="color:#4dc742; text-align:right">119</span>
      <span style="color:#4dc742; text-align:right">120</span>
      <span style="color:#4dc742; text-align:right">121</span>
      <span style="color:#4dc742; text-align:right">122</span>
      <span style="color:#4dc742; text-align:right">123</span>
      <span style="color:#4dc742; text-align:right">124</span>
      <span style="color:#4dc742; text-align:right">125</span>
      <span style="color:#4dc742; text-align:right">126</span>
      <span style="color:#4dc742; text-align:right">127</span>
      <span style="color:#4dc742; text-align:right">128</span>
      <span style="color:#4dc742; text-align:right">129</span>
      <span style="color:#4dc742; text-align:right">130</span>
      <span style="color:#4dc742; text-align:right">131</span>
      <span style="color:#4dc742; text-align:right">132</span>
      <span style="color:#4dc742; text-align:right">133</span>
      <span style="color:#4dc742; text-align:right">134</span>
      <span style="color:#4dc742; text-align:right">135</span>
      <span style="color:#4dc742; text-align:right">136</span>
      <span style="color:#4dc742; text-align:right">137</span>
      <span style="color:#4dc742; text-align:right">138</span>
      <span style="color:#4dc742; text-align:right">139</span>
      <span style="color:#4dc742; text-align:right">140</span>
      <span style="color:#4dc742; text-align:right">141</span>
      <span style="color:#4dc742; text-align:right">142</span>
      <span style="color:#4dc742; text-align:right">143</span>
      <span style="color:#4dc742; text-align:right">144</span>
      <span style="color:#4dc742; text-align:right">145</span>
      <span style="color:#4dc742; text-align:right">146</span>
      <span style="color:#4dc742; text-align:right">147</span>
      <span style="color:#4dc742; text-align:right">148</span>
      <span style="color:#4dc742; text-align:right">149</span>
      <span style="color:#4dc742; text-align:right">150</span>
      <span style="color:#4dc742; text-align:right">151</span>
      <span style="color:#4dc742; text-align:right">152</span>
      <span style="color:#4dc742; text-align:right">153</span>
      <span style="color:#4dc742; text-align:right">154</span>
      <span style="color:#4dc742; text-align:right">155</span>
      <span style="color:#4dc742; text-align:right">156</span>
      <span style="color:#4dc742; text-align:right">157</span>
      <span style="color:#4dc742; text-align:right">158</span>
      <span style="color:#4dc742; text-align:right">159</span>
      <span style="color:#4dc742; text-align:right">160</span>
      <span style="color:#4dc742; text-align:right">161</span>
      <span style="color:#4dc742; text-align:right">162</span>
      <span style="color:#4dc742; text-align:right">163</span>
      <span style="color:#4dc742; text-align:right">164</span>
      <span style="color:#4dc742; text-align:right">165</span>
      <span style="color:#4dc742; text-align:right">166</span>
      <span style="color:#4dc742; text-align:right">167</span>
      <span style="color:#4dc742; text-align:right">168</span>
      <span style="color:#4dc742; text-align:right">169</span>
      <span style="color:#4dc742; text-align:right">170</span>
      <span style="color:#4dc742; text-align:right">171</span>
      <span style="color:#4dc742; text-align:right">172</span>
      <span style="color:#4dc742; text-align:right">173</span>
      <span style="color:#4dc742; text-align:right">174</span>
      <span style="color:#4dc742; text-align:right">175</span>
      <span style="color:#4dc742; text-align:right">176</span>
      <span style="color:#4dc742; text-align:right">177</span>
      <span style="color:#4dc742; text-align:right">178</span>
      <span style="color:#4dc742; text-align:right">179</span>
      <span style="color:#4dc742; text-align:right">180</span>
      <span style="color:#4dc742; text-align:right">181</span>
      <span style="color:#4dc742; text-align:right">182</span>
      <span style="color:#4dc742; text-align:right">183</span>
      <span style="color:#4dc742; text-align:right">184</span>
      <span style="color:#4dc742; text-align:right">185</span>
      <span style="color:#4dc742; text-align:right">186</span>
      <span style="color:#4dc742; text-align:right">187</span>
      <span style="color:#4dc742; text-align:right">188</span>
      <span style="color:#4dc742; text-align:right">189</span>
      <span style="color:#4dc742; text-align:right">190</span>
      <span style="color:#4dc742; text-align:right">191</span>
      <span style="color:#4dc742; text-align:right">192</span>
      <span style="color:#4dc742; text-align:right">193</span>
      <span style="color:#4dc742; text-align:right">194</span>
      <span style="color:#4dc742; text-align:right">195</span>
      <span style="color:#4dc742; text-align:right">196</span>
      <span style="color:#4dc742; text-align:right">197</span>
      <span style="color:#4dc742; text-align:right">198</span>
      <span style="color:#4dc742; text-align:right">199</span>
      <span style="color:#4dc742; text-align:right">200</span>
      <span style="color:#4dc742; text-align:right">201</span>
      <span style="color:#4dc742; text-align:right">202</span>
      <span style="color:#4dc742; text-align:right">203</span>
      <span style="color:#4dc742; text-align:right">204</span>
      <span style="color:#4dc742; text-align:right">205</span>
      <span style="color:#4dc742; text-align:right">206</span>
      <span style="color:#4dc742; text-align:right">207</span>
      <span style="color:#4dc742; text-align:right">208</span>
      <span style="color:#4dc742; text-align:right">209</span>
      <span style="color:#4dc742; text-align:right">210</span>
      <span style="color:#4dc742; text-align:right">211</span>
      <span style="color:#4dc742; text-align:right">212</span>
      <span style="color:#4dc742; text-align:right">213</span>
      <span style="color:#4dc742; text-align:right">214</span>
      <span style="color:#4dc742; text-align:right">215</span>
      <span style="color:#4dc742; text-align:right">216</span>
      <span style="color:#4dc742; text-align:right">217</span>
      <span style="color:#4dc742; text-align:right">218</span>
      <span style="color:#4dc742; text-align:right">219</span>
      <span style="color:#4dc742; text-align:right">220</span>
      <span style="color:#4dc742; text-align:right">221</span>
      <span style="color:#4dc742; text-align:right">222</span>
      <span style="color:#4dc742; text-align:right">223</span>
      <span style="color:#4dc742; text-align:right">224</span>
      <span style="color:#4dc742; text-align:right">225</span>
      <span style="color:#4dc742; text-align:right">226</span>
      <span style="color:#4dc742; text-align:right">227</span>
      <span style="color:#4dc742; text-align:right">228</span>
      <span style="color:#4dc742; text-align:right">229</span>
      <span style="color:#4dc742; text-align:right">230</span>
      <span style="color:#4dc742; text-align:right">231</span>
      <span style="color:#4dc742; text-align:right">232</span>
      <span style="color:#4dc742; text-align:right">233</span>
      <span style="color:#4dc742; text-align:right">234</span>
      <span style="color:#4dc742; text-align:right">235</span>
      <span style="color:#4dc742; text-align:right">236</span>
      <span style="color:#4dc742; text-align:right">237</span>
      <span style="color:#4dc742; text-align:right">238</span>
      <span style="color:#4dc742; text-align:right">239</span>
      <span style="color:#4dc742; text-align:right">240</span>
      <span style="color:#4dc742; text-align:right">241</span>
      <span style="color:#4dc742; text-align:right">242</span>
      <span style="color:#4dc742; text-align:right">243</span>
      <span style="color:#4dc742; text-align:right">244</span>
      <span style="color:#4dc742; text-align:right">245</span>
      <span style="color:#4dc742; text-align:right">246</span>
      <span style="color:#4dc742; text-align:right">247</span>
      <span style="color:#4dc742; text-align:right">248</span>
      <span style="color:#4dc742; text-align:right">249</span>
      <span style="color:#4dc742; text-align:right">250</span>
      <span style="color:#4dc742; text-align:right">251</span>
      <span style="color:#4dc742; text-align:right">252</span>
      <span style="color:#4dc742; text-align:right">253</span>
      <span style="color:#4dc742; text-align:right">254</span>
      </div>
    </div>
    <div id="codes">
      <pre style="font-family:Consolas;font-size:24px;color:gainsboro;background:#1e1e1e;"><span style="color:#57a64a;">//1.//////////////////////////////////////////////////////</span><br/><span style="color:#57a64a;">//&nbsp;线程函数&nbsp;签名不限制</span><br/><span style="color:#569cd6;">void</span>&nbsp;<span style="color:#ff8000;">thread_func1</span><span style="color:#b4b4b4;">()</span><br/><span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#57a64a;">//&nbsp;...</span><br/><span style="color:#b4b4b4;">}</span><br/> <br/><span style="color:#569cd6;">void</span>&nbsp;<span style="color:#ff8000;">thread_func2</span><span style="color:#b4b4b4;">(</span><span style="color:#569cd6;">int</span>&nbsp;<span style="color:darkkhaki;">p1</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#569cd6;">double</span>&nbsp;<span style="color:darkkhaki;">p2</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#569cd6;">const</span>&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">string</span><span style="color:#b4b4b4;">&amp;</span>&nbsp;<span style="color:darkkhaki;">p3</span><span style="color:#b4b4b4;">)</span><br/><span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#57a64a;">//&nbsp;...</span><br/><span style="color:#b4b4b4;">}</span><br/> <br/><span style="color:#569cd6;">template</span><span style="color:#b4b4b4;">&lt;</span><span style="color:#569cd6;">typename</span><span style="color:#b4b4b4;">...</span>&nbsp;Args<span style="color:#b4b4b4;">&gt;</span><br/><span style="color:#569cd6;">bool</span>&nbsp;<span style="color:#ff8000;">thread_func3</span><span style="color:#b4b4b4;">(</span>Args<span style="color:#b4b4b4;">&amp;&amp;...</span>&nbsp;args<span style="color:#b4b4b4;">)</span><br/><span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#57a64a;">//&nbsp;...</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#569cd6;">return</span>&nbsp;<span style="color:#569cd6;">true</span><span style="color:#b4b4b4;">;</span><br/><span style="color:#b4b4b4;">}</span><br/> <br/><span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">thread</span>&nbsp;<span style="color:gold;">t1</span><span style="color:#b4b4b4;">(</span><span style="color:#ff8000;">thread_func1</span><span style="color:#b4b4b4;">);</span><br/><span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">string</span>&nbsp;<span style="color:darkkhaki;">s1</span>&nbsp;<span style="color:#b4b4b4;">=</span>&nbsp;<span style="color:#d69d85;">&quot;abc&quot;</span><span style="color:#b4b4b4;">;</span><br/><span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">thread</span>&nbsp;<span style="color:#ff8000;">t2</span><span style="color:#b4b4b4;">(</span><span style="color:#ff8000;">thread_func2</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#b5cea8;">1</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#b5cea8;">3.14</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:#ff8000;">cref</span><span style="color:#b4b4b4;">(</span><span style="color:darkkhaki;">s1</span><span style="color:#b4b4b4;">));</span>&nbsp;<span style="color:#57a64a;">//&nbsp;同std::bind一样，引用需要用std::ref/cref包装</span><br/><span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">thread</span>&nbsp;<span style="color:#ff8000;">t3</span><span style="color:#b4b4b4;">(</span><span style="color:#ff8000;">thread_func3</span><span style="color:#b4b4b4;">&lt;</span><span style="color:#569cd6;">int</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#569cd6;">int</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#569cd6;">const</span>&nbsp;<span style="color:#569cd6;">char</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#569cd6;">const</span>&nbsp;<span style="color:#569cd6;">char</span><span style="color:#b4b4b4;">*,</span>&nbsp;<span style="color:#569cd6;">const</span>&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">string</span><span style="color:#b4b4b4;">&amp;&gt;,</span>&nbsp;<span style="color:#b5cea8;">1</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#b5cea8;">2</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#d69d85;">&#39;A&#39;</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#d69d85;">&quot;hello&quot;</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:darkkhaki;">s1</span><span style="color:#b4b4b4;">);</span><br/> <br/><span style="color:gold;">t1</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">detach</span><span style="color:#b4b4b4;">();</span>&nbsp;<span style="color:#57a64a;">//&nbsp;分离，之后不能再join，后台执行完了之后自动结束，一般用于deamon</span><br/><span style="color:#ff8000;">t2</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">join</span><span style="color:#b4b4b4;">();</span>&nbsp;<span style="color:#57a64a;">//&nbsp;等待线程完成&nbsp;可通过&nbsp;t2.joinable()&nbsp;判断是否可以join</span><br/> <br/><span style="color:#57a64a;">//2.//////////////////////////////////////////////////////</span><br/><span style="color:#57a64a;">//&nbsp;this_thread</span><br/><span style="color:#569cd6;">auto</span>&nbsp;<span style="color:darkkhaki;">id</span>&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">this_thread</span><span style="color:#b4b4b4;">::</span><span style="color:#ff8000;">get_id</span><span style="color:#b4b4b4;">();</span>&nbsp;<span style="color:#57a64a;">//&nbsp;唯一标识符</span><br/><span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">this_thread</span><span style="color:#b4b4b4;">::</span><span style="color:#ff8000;">sleep_for</span><span style="color:#b4b4b4;">(</span><span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">chrono</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">seconds</span><span style="color:#b4b4b4;">(</span><span style="color:#b5cea8;">10</span><span style="color:#b4b4b4;">));</span><br/><span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">this_thread</span><span style="color:#b4b4b4;">::</span><span style="color:#ff8000;">sleep_until</span><span style="color:#b4b4b4;">(</span><span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">chrono</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">steady_clock</span><span style="color:#b4b4b4;">::</span><span style="color:#ff8000;">now</span><span style="color:#b4b4b4;">()</span>&nbsp;<span style="color:#b4b4b4;">+</span>&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">chrono</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">seconds</span><span style="color:#b4b4b4;">(</span><span style="color:#b5cea8;">10</span><span style="color:#b4b4b4;">));</span><br/><span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">this_thread</span><span style="color:#b4b4b4;">::</span><span style="color:#ff8000;">yield</span><span style="color:#b4b4b4;">();</span>&nbsp;<span style="color:#57a64a;">//取决于实现，效果可以理解为主动让出cpu使用权</span><br/> <br/><span style="color:#57a64a;">//3.//////////////////////////////////////////////////////</span><br/><span style="color:#57a64a;">//&nbsp;条件变量&nbsp;/&nbsp;互斥锁</span><br/><span style="color:#569cd6;">template</span><span style="color:#b4b4b4;">&lt;</span><span style="color:#569cd6;">typename</span>&nbsp;<span style="color:gold;">T</span><span style="color:#b4b4b4;">&gt;</span><br/><span style="color:#569cd6;">auto</span>&nbsp;<span style="color:#ff8000;">Produce</span><span style="color:#b4b4b4;">()</span>&nbsp;<span style="color:#b4b4b4;">-&gt;</span>&nbsp;<span style="color:gold;">T</span><span style="color:#b4b4b4;">&amp;&amp;</span><br/><span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#569cd6;">return</span>&nbsp;<span style="color:gold;">T</span><span style="color:#b4b4b4;">();</span><br/><span style="color:#b4b4b4;">}</span><br/> <br/><span style="color:#569cd6;">template</span><span style="color:#b4b4b4;">&lt;</span><span style="color:#569cd6;">typename</span>&nbsp;<span style="color:gold;">T</span><span style="color:#b4b4b4;">&gt;</span><br/><span style="color:#569cd6;">void</span>&nbsp;<span style="color:#ff8000;">Consume</span><span style="color:#b4b4b4;">(</span><span style="color:gold;">T</span><span style="color:#b4b4b4;">&amp;&amp;</span>&nbsp;<span style="color:darkkhaki;">p</span><span style="color:#b4b4b4;">)</span><br/><span style="color:#b4b4b4;">{</span><br/><span style="color:#b4b4b4;">}</span><br/> <br/><span style="color:#569cd6;">template</span><span style="color:#b4b4b4;">&lt;</span><span style="color:#569cd6;">typename</span>&nbsp;<span style="color:gold;">T</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:gold;">size_t</span>&nbsp;<span style="color:darkkhaki;">N</span><span style="color:#b4b4b4;">&gt;</span><br/><span style="color:#569cd6;">class</span>&nbsp;<span style="color:gold;">Store</span><br/><span style="color:#b4b4b4;">{</span><br/><span style="color:#569cd6;">public</span><span style="color:#b4b4b4;">:</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#569cd6;">void</span>&nbsp;<span style="color:#ff8000;">Produce</span><span style="color:#b4b4b4;">()</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">unique_lock</span>&nbsp;<span style="color:gold;">l</span><span style="color:#b4b4b4;">(</span><span style="color:darkkhaki;">m_mutex</span><span style="color:#b4b4b4;">);</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#569cd6;">while</span>&nbsp;<span style="color:#b4b4b4;">(</span><span style="color:darkkhaki;">m_products</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">size</span><span style="color:#b4b4b4;">()</span>&nbsp;<span style="color:#b4b4b4;">&gt;=</span>&nbsp;<span style="color:darkkhaki;">N</span><span style="color:#b4b4b4;">)</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:darkkhaki;">m_cv_p</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">wait</span><span style="color:#b4b4b4;">(</span><span style="color:gold;">l</span><span style="color:#b4b4b4;">);</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">}</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:darkkhaki;">cout</span>&nbsp;<span style="color:#b4b4b4;">&lt;&lt;</span>&nbsp;<span style="color:#d69d85;">&quot;store&nbsp;size&nbsp;is&nbsp;&quot;</span>&nbsp;<span style="color:#b4b4b4;">&lt;&lt;</span>&nbsp;<span style="color:darkkhaki;">m_products</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">size</span><span style="color:#b4b4b4;">()</span>&nbsp;<span style="color:#b4b4b4;">&lt;&lt;</span>&nbsp;<span style="color:#d69d85;">&quot;.&quot;</span>&nbsp;<span style="color:#b4b4b4;">&lt;&lt;</span>&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:#ff8000;">endl</span><span style="color:#b4b4b4;">;</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:darkkhaki;">m_products</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">push_back</span><span style="color:#b4b4b4;">(::</span><span style="color:#ff8000;">Produce</span><span style="color:#b4b4b4;">&lt;</span><span style="color:gold;">T</span><span style="color:#b4b4b4;">&gt;());</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#569cd6;">if</span>&nbsp;<span style="color:#b4b4b4;">(</span><span style="color:darkkhaki;">m_products</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">size</span><span style="color:#b4b4b4;">()</span>&nbsp;<span style="color:#b4b4b4;">==</span>&nbsp;<span style="color:#b5cea8;">1</span><span style="color:#b4b4b4;">)</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:darkkhaki;">m_cv_c</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">notify_all</span><span style="color:#b4b4b4;">();</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">}</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">}</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#569cd6;">void</span>&nbsp;<span style="color:#ff8000;">Consume</span><span style="color:#b4b4b4;">()</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">unique_lock</span>&nbsp;<span style="color:gold;">l</span><span style="color:#b4b4b4;">(</span><span style="color:darkkhaki;">m_mutex</span><span style="color:#b4b4b4;">);</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#569cd6;">while</span>&nbsp;<span style="color:#b4b4b4;">(</span><span style="color:darkkhaki;">m_products</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">empty</span><span style="color:#b4b4b4;">())</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:darkkhaki;">m_cv_c</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">wait</span><span style="color:#b4b4b4;">(</span><span style="color:gold;">l</span><span style="color:#b4b4b4;">);</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">}</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:darkkhaki;">cout</span>&nbsp;<span style="color:#b4b4b4;">&lt;&lt;</span>&nbsp;<span style="color:#d69d85;">&quot;store&nbsp;size&nbsp;is&nbsp;&quot;</span>&nbsp;<span style="color:#b4b4b4;">&lt;&lt;</span>&nbsp;<span style="color:darkkhaki;">m_products</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">size</span><span style="color:#b4b4b4;">()</span>&nbsp;<span style="color:#b4b4b4;">&lt;&lt;</span>&nbsp;<span style="color:#d69d85;">&quot;.&quot;</span>&nbsp;<span style="color:#b4b4b4;">&lt;&lt;</span>&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:#ff8000;">endl</span><span style="color:#b4b4b4;">;</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">::</span><span style="color:#ff8000;">Consume</span><span style="color:#b4b4b4;">&lt;</span><span style="color:gold;">T</span><span style="color:#b4b4b4;">&gt;(</span><span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:#ff8000;">move</span><span style="color:#b4b4b4;">(</span><span style="color:darkkhaki;">m_products</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">front</span><span style="color:#b4b4b4;">()));</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#569cd6;">if</span>&nbsp;<span style="color:#b4b4b4;">(</span><span style="color:darkkhaki;">m_products</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">size</span><span style="color:#b4b4b4;">()</span>&nbsp;<span style="color:#b4b4b4;">==</span>&nbsp;<span style="color:darkkhaki;">N</span><span style="color:#b4b4b4;">)</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:darkkhaki;">m_cv_p</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">notify_all</span><span style="color:#b4b4b4;">();</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">}</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:darkkhaki;">m_products</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">pop_front</span><span style="color:#b4b4b4;">();</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">}</span><br/> <br/><span style="color:#569cd6;">private</span><span style="color:#b4b4b4;">:</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">list</span><span style="color:#b4b4b4;">&lt;</span><span style="color:gold;">T</span><span style="color:#b4b4b4;">&gt;</span>&nbsp;<span style="color:darkkhaki;">m_products</span><span style="color:#b4b4b4;">;</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">mutex</span>&nbsp;<span style="color:darkkhaki;">m_mutex</span><span style="color:#b4b4b4;">;</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">condition_variable</span>&nbsp;<span style="color:darkkhaki;">m_cv_p</span><span style="color:#b4b4b4;">;</span>&nbsp;<span style="color:#57a64a;">//&nbsp;full&nbsp;-&gt;&nbsp;not&nbsp;full&nbsp;</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">condition_variable</span>&nbsp;<span style="color:darkkhaki;">m_cv_c</span><span style="color:#b4b4b4;">;</span>&nbsp;<span style="color:#57a64a;">//&nbsp;empty&nbsp;-&gt;&nbsp;not&nbsp;empty</span><br/><span style="color:#b4b4b4;">};</span><br/> <br/><span style="color:#569cd6;">class</span>&nbsp;<span style="color:gold;">D</span>&nbsp;<span style="color:#b4b4b4;">{};</span><br/> <br/><span style="color:#569cd6;">void</span>&nbsp;<span style="color:#ff8000;">test</span><span style="color:#b4b4b4;">()</span><br/><span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">Store</span><span style="color:#b4b4b4;">&lt;</span><span style="color:gold;">D</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#b5cea8;">10</span><span style="color:#b4b4b4;">&gt;</span>&nbsp;<span style="color:darkkhaki;">dstore</span><span style="color:#b4b4b4;">;</span><br/> <br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#569cd6;">auto</span>&nbsp;<span style="color:darkkhaki;">tpf</span>&nbsp;<span style="color:#b4b4b4;">=</span>&nbsp;<span style="color:#b4b4b4;">[&amp;</span><span style="color:darkkhaki;">dstore</span><span style="color:#b4b4b4;">](</span><span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">chrono</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">system_clock</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">duration</span>&nbsp;<span style="color:darkkhaki;">d</span><span style="color:#b4b4b4;">)</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#569cd6;">while</span>&nbsp;<span style="color:#b4b4b4;">(</span><span style="color:#569cd6;">true</span><span style="color:#b4b4b4;">)</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:darkkhaki;">dstore</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">Produce</span><span style="color:#b4b4b4;">();</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">this_thread</span><span style="color:#b4b4b4;">::</span><span style="color:#ff8000;">sleep_for</span><span style="color:#b4b4b4;">(</span><span style="color:darkkhaki;">d</span><span style="color:#b4b4b4;">);</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">}</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">};</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#569cd6;">auto</span>&nbsp;<span style="color:darkkhaki;">tcf</span>&nbsp;<span style="color:#b4b4b4;">=</span>&nbsp;<span style="color:#b4b4b4;">[&amp;</span><span style="color:darkkhaki;">dstore</span><span style="color:#b4b4b4;">](</span><span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">chrono</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">system_clock</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">duration</span>&nbsp;<span style="color:darkkhaki;">d</span><span style="color:#b4b4b4;">)</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#569cd6;">while</span>&nbsp;<span style="color:#b4b4b4;">(</span><span style="color:#569cd6;">true</span><span style="color:#b4b4b4;">)</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:darkkhaki;">dstore</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">Consume</span><span style="color:#b4b4b4;">();</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">this_thread</span><span style="color:#b4b4b4;">::</span><span style="color:#ff8000;">sleep_for</span><span style="color:#b4b4b4;">(</span><span style="color:darkkhaki;">d</span><span style="color:#b4b4b4;">);</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">}</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">};</span><br/> <br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">thread</span>&nbsp;<span style="color:darkkhaki;">tp1</span><span style="color:#b4b4b4;">(</span><span style="color:darkkhaki;">tpf</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#b5cea8;">1</span>ms<span style="color:#b4b4b4;">);</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">thread</span>&nbsp;<span style="color:darkkhaki;">tp2</span><span style="color:#b4b4b4;">(</span><span style="color:darkkhaki;">tpf</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#b5cea8;">3</span>ms<span style="color:#b4b4b4;">);</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">thread</span>&nbsp;<span style="color:darkkhaki;">tc1</span><span style="color:#b4b4b4;">(</span><span style="color:darkkhaki;">tcf</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#b5cea8;">2</span>s<span style="color:#b4b4b4;">);</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">thread</span>&nbsp;<span style="color:darkkhaki;">tc2</span><span style="color:#b4b4b4;">(</span><span style="color:darkkhaki;">tcf</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#b5cea8;">2</span>s<span style="color:#b4b4b4;">);</span><br/> <br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:darkkhaki;">tp1</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">join</span><span style="color:#b4b4b4;">();</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:darkkhaki;">tp2</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">join</span><span style="color:#b4b4b4;">();</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:darkkhaki;">tc1</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">join</span><span style="color:#b4b4b4;">();</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:darkkhaki;">tc2</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">join</span><span style="color:#b4b4b4;">();</span><br/><span style="color:#b4b4b4;">}</span><br/> <br/><span style="color:#57a64a;">//&nbsp;其他：&nbsp;&nbsp;&nbsp;&nbsp;std::recursive_mutex&nbsp;&nbsp;&nbsp;&nbsp;std::shared_mutex</span><br/><span style="color:#57a64a;">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std::lock_guard&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std::shared_lock</span><br/> <br/><span style="color:#57a64a;">//4.//////////////////////////////////////////////////////</span><br/><span style="color:#57a64a;">//&nbsp;异步操作</span><br/><span style="color:#9b9b9b;">#include</span>&nbsp;<span style="color:#d69d85;">&lt;feature&gt;</span><br/><span style="color:#569cd6;">int</span>&nbsp;<span style="color:#ff8000;">GetFlagByRpc</span><span style="color:#b4b4b4;">(</span><span style="color:#569cd6;">const</span>&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">string</span><span style="color:#b4b4b4;">&amp;</span>&nbsp;<span style="color:darkkhaki;">URL</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#569cd6;">const</span>&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">string</span><span style="color:#b4b4b4;">&amp;</span>&nbsp;<span style="color:darkkhaki;">param</span><span style="color:#b4b4b4;">)</span><br/><span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#57a64a;">//...</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#569cd6;">return</span>&nbsp;<span style="color:#b5cea8;">1000</span><span style="color:#b4b4b4;">;</span><br/><span style="color:#b4b4b4;">}</span><br/><span style="color:#569cd6;">auto</span>&nbsp;<span style="color:darkkhaki;">x1</span>&nbsp;<span style="color:#b4b4b4;">=</span>&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:#ff8000;">async</span><span style="color:#b4b4b4;">(</span><span style="color:#ff8000;">GetFlagByRpc</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#d69d85;">&quot;url&quot;</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#d69d85;">&quot;param&quot;</span><span style="color:#b4b4b4;">);</span>&nbsp;<span style="color:#57a64a;">//&nbsp;等同于策略&nbsp;std::launch::async&nbsp;|&nbsp;std::launch::deferred</span><br/><span style="color:#57a64a;">//&nbsp;...&nbsp;</span><br/><span style="color:#569cd6;">int</span>&nbsp;<span style="color:darkkhaki;">flag</span>&nbsp;<span style="color:#b4b4b4;">=</span>&nbsp;<span style="color:darkkhaki;">x</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">get</span><span style="color:#b4b4b4;">();</span>&nbsp;<span style="color:#57a64a;">//如果此时异步操作已完成，直接获取结果，否则会阻塞</span><br/> <br/><span style="color:#569cd6;">auto</span>&nbsp;<span style="color:darkkhaki;">x2</span>&nbsp;<span style="color:#b4b4b4;">=</span>&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:#ff8000;">async</span><span style="color:#b4b4b4;">(</span><span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span>launch<span style="color:#b4b4b4;">::</span><span style="color:#ff8000;">async</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#ff8000;">GetFlagByRpc</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#d69d85;">&quot;url&quot;</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#d69d85;">&quot;param&quot;</span><span style="color:#b4b4b4;">);</span><br/> <br/><span style="color:#57a64a;">//&nbsp;promise</span><br/><span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span>promise<span style="color:#b4b4b4;">&lt;</span><span style="color:#569cd6;">int</span><span style="color:#b4b4b4;">&gt;</span>&nbsp;<span style="color:darkkhaki;">flag</span><span style="color:#b4b4b4;">;</span><br/><span style="color:#569cd6;">void</span>&nbsp;<span style="color:#ff8000;">SetFlagByRpc</span><span style="color:#b4b4b4;">(</span><span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span>promise<span style="color:#b4b4b4;">&lt;</span><span style="color:#569cd6;">int</span><span style="color:#b4b4b4;">&gt;</span>&nbsp;<span style="color:darkkhaki;">flag</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#569cd6;">const</span>&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">string</span><span style="color:#b4b4b4;">&amp;</span>&nbsp;<span style="color:darkkhaki;">URL</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#569cd6;">const</span>&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">string</span><span style="color:#b4b4b4;">&amp;</span>&nbsp;<span style="color:darkkhaki;">param</span><span style="color:#b4b4b4;">)</span><br/><span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#57a64a;">//...</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:darkkhaki;">flag</span><span style="color:#b4b4b4;">.</span>set_value_at_thread_exit<span style="color:#b4b4b4;">(</span><span style="color:#b5cea8;">1000</span><span style="color:#b4b4b4;">);</span><br/><span style="color:#b4b4b4;">}</span><br/><span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:#ff8000;">async</span><span style="color:#b4b4b4;">(</span><span style="color:darkkhaki;">flag</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#ff8000;">GetFlagByRpc</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#d69d85;">&quot;url&quot;</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#d69d85;">&quot;param&quot;</span><span style="color:#b4b4b4;">);</span><br/><span style="color:#569cd6;">int</span>&nbsp;<span style="color:darkkhaki;">rflag</span>&nbsp;<span style="color:#b4b4b4;">=</span>&nbsp;<span style="color:darkkhaki;">flag</span><span style="color:#b4b4b4;">.</span>get_feature<span style="color:#b4b4b4;">().</span><span style="color:#ff8000;">get</span><span style="color:#b4b4b4;">();</span><br/> <br/><span style="color:#57a64a;">//&nbsp;std::shared_feature&nbsp;类似&nbsp;std::shared_ptr&lt;std::feature&gt;</span><br/><span style="color:#57a64a;">//&nbsp;配合std::promise的set_value可以实现异步事件通知的效果</span><br/> <br/><span style="color:#57a64a;">//packaged_task</span><br/><span style="color:#569cd6;">int</span>&nbsp;<span style="color:#ff8000;">f</span><span style="color:#b4b4b4;">(</span><span style="color:#569cd6;">int</span>&nbsp;<span style="color:darkkhaki;">x</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#569cd6;">int</span>&nbsp;<span style="color:darkkhaki;">y</span><span style="color:#b4b4b4;">)</span>&nbsp;<span style="color:#b4b4b4;">{</span>&nbsp;<span style="color:#569cd6;">return</span>&nbsp;<span style="color:darkkhaki;">x</span>&nbsp;<span style="color:#b4b4b4;">+</span>&nbsp;<span style="color:darkkhaki;">y</span><span style="color:#b4b4b4;">;</span>&nbsp;<span style="color:#b4b4b4;">}</span><br/> <br/><span style="color:#569cd6;">void</span>&nbsp;<span style="color:#ff8000;">task_lambda</span><span style="color:#b4b4b4;">()</span><br/><span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span>packaged_task<span style="color:#b4b4b4;">&lt;</span><span style="color:#569cd6;">int</span><span style="color:#b4b4b4;">(</span><span style="color:#569cd6;">int</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#569cd6;">int</span><span style="color:#b4b4b4;">)&gt;</span>&nbsp;<span style="color:#ff8000;">task</span><span style="color:#b4b4b4;">([](</span><span style="color:#569cd6;">int</span>&nbsp;<span style="color:gold;">a</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#569cd6;">int</span>&nbsp;<span style="color:darkkhaki;">b</span><span style="color:#b4b4b4;">)</span>&nbsp;<span style="color:#b4b4b4;">{</span>&nbsp;<span style="color:#569cd6;">return</span>&nbsp;<span style="color:darkkhaki;">x</span>&nbsp;<span style="color:#b4b4b4;">+</span>&nbsp;<span style="color:darkkhaki;">y</span><span style="color:#b4b4b4;">;</span>&nbsp;<span style="color:#b4b4b4;">});</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span>future<span style="color:#b4b4b4;">&lt;</span><span style="color:#569cd6;">int</span><span style="color:#b4b4b4;">&gt;</span>&nbsp;<span style="color:darkkhaki;">result</span>&nbsp;<span style="color:#b4b4b4;">=</span>&nbsp;<span style="color:#ff8000;">task</span><span style="color:#b4b4b4;">.</span>get_future<span style="color:#b4b4b4;">();</span><br/> <br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff8000;">task</span><span style="color:#b4b4b4;">(</span><span style="color:#b5cea8;">2</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#b5cea8;">9</span><span style="color:#b4b4b4;">);</span>&nbsp;<span style="color:#57a64a;">//&nbsp;同步调用</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:darkkhaki;">cout</span>&nbsp;<span style="color:#b4b4b4;">&lt;&lt;</span>&nbsp;<span style="color:#d69d85;">&quot;task_lambda:\t&quot;</span>&nbsp;<span style="color:#b4b4b4;">&lt;&lt;</span>&nbsp;<span style="color:darkkhaki;">result</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">get</span><span style="color:#b4b4b4;">()</span>&nbsp;<span style="color:#b4b4b4;">&lt;&lt;</span>&nbsp;<span style="color:#d69d85;">&#39;\n&#39;</span><span style="color:#b4b4b4;">;</span><br/><span style="color:#b4b4b4;">}</span><br/> <br/><span style="color:#569cd6;">void</span>&nbsp;<span style="color:#ff8000;">task_bind</span><span style="color:#b4b4b4;">()</span><br/><span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span>packaged_task<span style="color:#b4b4b4;">&lt;</span><span style="color:#569cd6;">int</span><span style="color:#b4b4b4;">()&gt;</span>&nbsp;<span style="color:#ff8000;">task</span><span style="color:#b4b4b4;">(</span><span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:#ff8000;">bind</span><span style="color:#b4b4b4;">(</span><span style="color:#ff8000;">f</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#b5cea8;">2</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#b5cea8;">11</span><span style="color:#b4b4b4;">));</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span>future<span style="color:#b4b4b4;">&lt;</span><span style="color:#569cd6;">int</span><span style="color:#b4b4b4;">&gt;</span>&nbsp;<span style="color:darkkhaki;">result</span>&nbsp;<span style="color:#b4b4b4;">=</span>&nbsp;<span style="color:#ff8000;">task</span><span style="color:#b4b4b4;">.</span>get_future<span style="color:#b4b4b4;">();</span><br/> <br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff8000;">task</span><span style="color:#b4b4b4;">();</span>&nbsp;<span style="color:#57a64a;">//&nbsp;同步调用</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:darkkhaki;">cout</span>&nbsp;<span style="color:#b4b4b4;">&lt;&lt;</span>&nbsp;<span style="color:#d69d85;">&quot;task_bind:\t&quot;</span>&nbsp;<span style="color:#b4b4b4;">&lt;&lt;</span>&nbsp;<span style="color:darkkhaki;">result</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">get</span><span style="color:#b4b4b4;">()</span>&nbsp;<span style="color:#b4b4b4;">&lt;&lt;</span>&nbsp;<span style="color:#d69d85;">&#39;\n&#39;</span><span style="color:#b4b4b4;">;</span><br/><span style="color:#b4b4b4;">}</span><br/> <br/><span style="color:#569cd6;">void</span>&nbsp;<span style="color:#ff8000;">task_thread</span><span style="color:#b4b4b4;">()</span><br/><span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span>packaged_task<span style="color:#b4b4b4;">&lt;</span><span style="color:#569cd6;">int</span><span style="color:#b4b4b4;">(</span><span style="color:#569cd6;">int</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#569cd6;">int</span><span style="color:#b4b4b4;">)&gt;</span>&nbsp;<span style="color:#ff8000;">task</span><span style="color:#b4b4b4;">(</span><span style="color:#ff8000;">f</span><span style="color:#b4b4b4;">);</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span>future<span style="color:#b4b4b4;">&lt;</span><span style="color:#569cd6;">int</span><span style="color:#b4b4b4;">&gt;</span>&nbsp;<span style="color:darkkhaki;">result</span>&nbsp;<span style="color:#b4b4b4;">=</span>&nbsp;<span style="color:#ff8000;">task</span><span style="color:#b4b4b4;">.</span>get_future<span style="color:#b4b4b4;">();</span><br/> <br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">thread</span>&nbsp;<span style="color:darkkhaki;">task_td</span><span style="color:#b4b4b4;">(</span><span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:#ff8000;">move</span><span style="color:#b4b4b4;">(</span><span style="color:#ff8000;">task</span><span style="color:#b4b4b4;">),</span>&nbsp;<span style="color:#b5cea8;">2</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#b5cea8;">10</span><span style="color:#b4b4b4;">);</span>&nbsp;<span style="color:#57a64a;">//&nbsp;异步调用</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:darkkhaki;">task_td</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">join</span><span style="color:#b4b4b4;">();</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:darkkhaki;">cout</span>&nbsp;<span style="color:#b4b4b4;">&lt;&lt;</span>&nbsp;<span style="color:#d69d85;">&quot;task_thread:\t&quot;</span>&nbsp;<span style="color:#b4b4b4;">&lt;&lt;</span>&nbsp;<span style="color:darkkhaki;">result</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">get</span><span style="color:#b4b4b4;">()</span>&nbsp;<span style="color:#b4b4b4;">&lt;&lt;</span>&nbsp;<span style="color:#d69d85;">&#39;\n&#39;</span><span style="color:#b4b4b4;">;</span><br/><span style="color:#b4b4b4;">}</span><br/> <br/><span style="color:#569cd6;">void</span>&nbsp;<span style="color:#ff8000;">test</span><span style="color:#b4b4b4;">()</span><br/><span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff8000;">task_lambda</span><span style="color:#b4b4b4;">();</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff8000;">task_bind</span><span style="color:#b4b4b4;">();</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff8000;">task_thread</span><span style="color:#b4b4b4;">();</span><br/><span style="color:#b4b4b4;">}</span><br/> <br/><span style="color:#57a64a;">//5.//////////////////////////////////////////////////////</span><br/><span style="color:#57a64a;">//&nbsp;原子操作&nbsp;&lt;atomic&gt;</span><br/><span style="color:#569cd6;">int</span>&nbsp;<span style="color:#ff8000;">ConcurrentGuid</span><span style="color:#b4b4b4;">()</span>&nbsp;<span style="color:#57a64a;">//&nbsp;可用于多线程并发下的GUID生成器</span><br/><span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#569cd6;">static</span>&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">atomic_int</span>&nbsp;<span style="color:darkkhaki;">id</span><span style="color:#b4b4b4;">;</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#569cd6;">return</span>&nbsp;<span style="color:#b4b4b4;">++</span><span style="color:darkkhaki;">id</span><span style="color:#b4b4b4;">;</span><br/><span style="color:#b4b4b4;">}</span><br/> <br/><span style="color:#57a64a;">//&nbsp;CAS</span><br/><span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">atomic_int</span>&nbsp;<span style="color:darkkhaki;">i</span>&nbsp;<span style="color:#b4b4b4;">=</span>&nbsp;<span style="color:#b5cea8;">1</span><span style="color:#b4b4b4;">;</span><br/><span style="color:#569cd6;">bool</span>&nbsp;<span style="color:darkkhaki;">exchanged</span>&nbsp;<span style="color:#b4b4b4;">=</span>&nbsp;<span style="color:darkkhaki;">i</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">compare_exchange_strong</span><span style="color:#b4b4b4;">(</span><span style="color:#b5cea8;">1</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#b5cea8;">2</span><span style="color:#b4b4b4;">);</span><br/><span style="color:#569cd6;">bool</span>&nbsp;<span style="color:darkkhaki;">exchanged</span>&nbsp;<span style="color:#b4b4b4;">=</span>&nbsp;<span style="color:darkkhaki;">i</span><span style="color:#b4b4b4;">.</span>compare_exchange_week<span style="color:#b4b4b4;">(</span><span style="color:#b5cea8;">1</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#b5cea8;">2</span><span style="color:#b4b4b4;">);</span><br/> <br/><span style="color:#57a64a;">//6.//////////////////////////////////////////////////////</span><br/><span style="color:#57a64a;">//&nbsp;thread&nbsp;once&nbsp;std::call_once&nbsp;std::once_flag;</span><br/><span style="color:#9b9b9b;">#include</span>&nbsp;<span style="color:#d69d85;">&lt;iostream&gt;</span><br/><span style="color:#9b9b9b;">#include</span>&nbsp;<span style="color:#d69d85;">&lt;thread&gt;</span><br/><span style="color:#9b9b9b;">#include</span>&nbsp;<span style="color:#d69d85;">&lt;mutex&gt;</span><br/> <br/><span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">once_flag</span>&nbsp;<span style="color:darkkhaki;">flag1</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:darkkhaki;">flag2</span><span style="color:#b4b4b4;">;</span><br/> <br/><span style="color:#569cd6;">void</span>&nbsp;<span style="color:#ff8000;">simple_do_once</span><span style="color:#b4b4b4;">()</span><br/><span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:#ff8000;">call_once</span><span style="color:#b4b4b4;">(</span><span style="color:darkkhaki;">flag1</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#b4b4b4;">[]()</span>&nbsp;<span style="color:#b4b4b4;">{</span>&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:darkkhaki;">cout</span>&nbsp;<span style="color:#b4b4b4;">&lt;&lt;</span>&nbsp;<span style="color:#d69d85;">&quot;Simple&nbsp;example:&nbsp;called&nbsp;once\n&quot;</span><span style="color:#b4b4b4;">;</span>&nbsp;<span style="color:#b4b4b4;">});</span><br/><span style="color:#b4b4b4;">}</span><br/> <br/><span style="color:#569cd6;">void</span>&nbsp;<span style="color:#ff8000;">may_throw_function</span><span style="color:#b4b4b4;">(</span><span style="color:#569cd6;">bool</span>&nbsp;<span style="color:darkkhaki;">do_throw</span><span style="color:#b4b4b4;">)</span><br/><span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#569cd6;">if</span>&nbsp;<span style="color:#b4b4b4;">(</span><span style="color:darkkhaki;">do_throw</span><span style="color:#b4b4b4;">)</span>&nbsp;<span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:darkkhaki;">cout</span>&nbsp;<span style="color:#b4b4b4;">&lt;&lt;</span>&nbsp;<span style="color:#d69d85;">&quot;throw:&nbsp;call_once&nbsp;will&nbsp;retry\n&quot;</span><span style="color:#b4b4b4;">;</span>&nbsp;<span style="color:#57a64a;">//&nbsp;这会出现多于一次</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#569cd6;">throw</span>&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">exception</span><span style="color:#b4b4b4;">();</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">}</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:darkkhaki;">cout</span>&nbsp;<span style="color:#b4b4b4;">&lt;&lt;</span>&nbsp;<span style="color:#d69d85;">&quot;Didn&#39;t&nbsp;throw,&nbsp;call_once&nbsp;will&nbsp;not&nbsp;attempt&nbsp;again\n&quot;</span><span style="color:#b4b4b4;">;</span>&nbsp;<span style="color:#57a64a;">//&nbsp;保证一次</span><br/><span style="color:#b4b4b4;">}</span><br/> <br/><span style="color:#569cd6;">void</span>&nbsp;<span style="color:#ff8000;">do_once</span><span style="color:#b4b4b4;">(</span><span style="color:#569cd6;">bool</span>&nbsp;<span style="color:darkkhaki;">do_throw</span><span style="color:#b4b4b4;">)</span><br/><span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#569cd6;">try</span>&nbsp;<span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:#ff8000;">call_once</span><span style="color:#b4b4b4;">(</span><span style="color:darkkhaki;">flag2</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#ff8000;">may_throw_function</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:darkkhaki;">do_throw</span><span style="color:#b4b4b4;">);</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">}</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#569cd6;">catch</span>&nbsp;<span style="color:#b4b4b4;">(...)</span>&nbsp;<span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#b4b4b4;">}</span><br/><span style="color:#b4b4b4;">}</span><br/> <br/><span style="color:#569cd6;">void</span>&nbsp;<span style="color:#ff8000;">test</span><span style="color:#b4b4b4;">()</span><br/><span style="color:#b4b4b4;">{</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">thread</span>&nbsp;<span style="color:darkkhaki;">st1</span><span style="color:#b4b4b4;">(</span><span style="color:#ff8000;">simple_do_once</span><span style="color:#b4b4b4;">);</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">thread</span>&nbsp;<span style="color:darkkhaki;">st2</span><span style="color:#b4b4b4;">(</span><span style="color:#ff8000;">simple_do_once</span><span style="color:#b4b4b4;">);</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:darkkhaki;">st1</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">join</span><span style="color:#b4b4b4;">();</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:darkkhaki;">st2</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">join</span><span style="color:#b4b4b4;">();</span><br/> <br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">thread</span>&nbsp;<span style="color:gold;">t1</span><span style="color:#b4b4b4;">(</span><span style="color:#ff8000;">do_once</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#569cd6;">true</span><span style="color:#b4b4b4;">);</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">thread</span>&nbsp;<span style="color:#ff8000;">t2</span><span style="color:#b4b4b4;">(</span><span style="color:#ff8000;">do_once</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#569cd6;">true</span><span style="color:#b4b4b4;">);</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">thread</span>&nbsp;<span style="color:#ff8000;">t3</span><span style="color:#b4b4b4;">(</span><span style="color:#ff8000;">do_once</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#569cd6;">false</span><span style="color:#b4b4b4;">);</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">std</span><span style="color:#b4b4b4;">::</span><span style="color:gold;">thread</span>&nbsp;<span style="color:darkkhaki;">t4</span><span style="color:#b4b4b4;">(</span><span style="color:#ff8000;">do_once</span><span style="color:#b4b4b4;">,</span>&nbsp;<span style="color:#569cd6;">true</span><span style="color:#b4b4b4;">);</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gold;">t1</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">join</span><span style="color:#b4b4b4;">();</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff8000;">t2</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">join</span><span style="color:#b4b4b4;">();</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff8000;">t3</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">join</span><span style="color:#b4b4b4;">();</span><br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:darkkhaki;">t4</span><span style="color:#b4b4b4;">.</span><span style="color:#ff8000;">join</span><span style="color:#b4b4b4;">();</span><br/><span style="color:#b4b4b4;">}</span><br/> <br/><span style="color:#57a64a;">//7.//////////////////////////////////////////////////////</span><br/><span style="color:#569cd6;">thread_local</span>&nbsp;<span style="color:#569cd6;">int</span>&nbsp;<span style="color:darkkhaki;">tl_flag</span>&nbsp;<span style="color:#b4b4b4;">=</span>&nbsp;<span style="color:#b5cea8;">1</span><span style="color:#b4b4b4;">;</span>&nbsp;<span style="color:#57a64a;">//线程独享静态变量，相当于线程内的static</span><br/> <br/></pre>
    </div>
  </body>
</html>
